"""update tables

Revision ID: dcd1c8e4fa3a
Revises: 
Create Date: 2026-02-14 04:07:24.259191

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
import app

# revision identifiers, used by Alembic.
revision: str = 'dcd1c8e4fa3a'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('organizations',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('type', sa.String(length=50), nullable=False, comment='over_the_counter, pharmacy, hospital_pharmacy, chain'),
    sa.Column('license_number', sa.String(length=100), nullable=True),
    sa.Column('tax_id', sa.String(length=50), nullable=True),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('address', app.models.db_types.JSONB(), nullable=True, comment='{ street, city, state, zip, country }'),
    sa.Column('settings', app.models.db_types.JSONB(), nullable=False, comment='Tax rates, business hours, preferences, etc.'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('subscription_tier', sa.String(length=50), nullable=False, comment='basic, professional, enterprise'),
    sa.Column('subscription_expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.CheckConstraint("subscription_tier IN ('basic', 'professional', 'enterprise')", name='check_subscription_tier'),
    sa.CheckConstraint("type IN ('otc', 'pharmacy', 'hospital_pharmacy', 'chain')", name='check_org_type'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('license_number')
    )
    with op.batch_alter_table('organizations', schema=None) as batch_op:
        batch_op.create_index('idx_org_active', ['is_active'], unique=False)
        batch_op.create_index('idx_org_subscription', ['subscription_tier', 'subscription_expires_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_organizations_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_organizations_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_organizations_name'), ['name'], unique=False)
        batch_op.create_index(batch_op.f('ix_organizations_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_organizations_updated_at'), ['updated_at'], unique=False)

    op.create_table('sync_queue',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('operation', sa.String(length=20), nullable=False, comment='create, update, delete'),
    sa.Column('table_name', sa.String(length=100), nullable=False),
    sa.Column('record_id', sa.String(length=100), nullable=False),
    sa.Column('data', app.models.db_types.JSONB(), nullable=False, comment='Full record data as JSON'),
    sa.Column('priority', sa.Integer(), nullable=False, comment='Higher priority processed first'),
    sa.Column('retry_count', sa.Integer(), nullable=False),
    sa.Column('max_retries', sa.Integer(), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False, comment='pending, processing, failed, completed'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('scheduled_at', sa.DateTime(timezone=True), nullable=True, comment='For retry backoff'),
    sa.Column('processed_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint("operation IN ('create', 'update', 'delete')", name='check_sync_operation'),
    sa.CheckConstraint("status IN ('pending', 'processing', 'failed', 'completed')", name='check_sync_status'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('sync_queue', schema=None) as batch_op:
        batch_op.create_index('idx_sync_queue_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_sync_queue_pending', ['status', 'scheduled_at'], unique=False, postgresql_where=sa.text("status = 'pending'"))
        batch_op.create_index('idx_sync_queue_scheduled', ['scheduled_at'], unique=False)
        batch_op.create_index('idx_sync_queue_status', ['status', 'priority'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_record_id'), ['record_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_scheduled_at'), ['scheduled_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_table_name'), ['table_name'], unique=False)

    op.create_table('users',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('username', sa.String(length=100), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=False),
    sa.Column('full_name', sa.String(length=255), nullable=False),
    sa.Column('role', sa.String(length=50), nullable=False, comment='super_admin, admin, manager, pharmacist, cashier, viewer'),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('employee_id', sa.String(length=50), nullable=True),
    sa.Column('assigned_branches', app.models.db_types.ARRAY(), nullable=False, comment='Branches this user can access'),
    sa.Column('permissions', app.models.db_types.JSONB(), nullable=False, comment="{ additional: ['perm1', 'perm2'], denied: ['perm3'] }"),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('last_login', sa.DateTime(timezone=True), nullable=True),
    sa.Column('failed_login_attempts', sa.Integer(), nullable=False),
    sa.Column('account_locked_until', sa.DateTime(timezone=True), nullable=True, comment='Account lock after failed attempts'),
    sa.Column('password_changed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('two_factor_enabled', sa.Boolean(), nullable=False),
    sa.Column('two_factor_secret', sa.String(length=255), nullable=True, comment='Encrypted TOTP secret'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.CheckConstraint("role IN ('super_admin', 'admin', 'manager', 'pharmacist', 'cashier', 'viewer')", name='check_user_role'),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.create_index('idx_user_active', ['is_active'], unique=False)
        batch_op.create_index('idx_user_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_user_role', ['role'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_email'), ['email'], unique=True)
        batch_op.create_index(batch_op.f('ix_users_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_role'), ['role'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_updated_at'), ['updated_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_username'), ['username'], unique=True)

    op.create_table('audit_logs',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('user_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('action', sa.String(length=100), nullable=False, comment='Action performed: create, update, delete, login, etc.'),
    sa.Column('entity_type', sa.String(length=100), nullable=True, comment='Table/model affected'),
    sa.Column('entity_id', app.models.db_types.UUID(length=36), nullable=True, comment='ID of affected record'),
    sa.Column('changes', app.models.db_types.JSONB(), nullable=True, comment='{ before: {...}, after: {...} }'),
    sa.Column('ip_address', app.models.db_types.INET(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('context_metadata', app.models.db_types.JSONB(), nullable=True, comment='Additional context about the action'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('audit_logs', schema=None) as batch_op:
        batch_op.create_index('idx_audit_action', ['action'], unique=False)
        batch_op.create_index('idx_audit_date', ['created_at'], unique=False)
        batch_op.create_index('idx_audit_entity', ['entity_type', 'entity_id'], unique=False)
        batch_op.create_index('idx_audit_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_audit_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_action'), ['action'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_entity_id'), ['entity_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_entity_type'), ['entity_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_user_id'), ['user_id'], unique=False)

    op.create_table('branches',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('code', sa.String(length=50), nullable=False, comment='Unique branch code for transactions'),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('address', app.models.db_types.JSONB(), nullable=True),
    sa.Column('manager_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('operating_hours', app.models.db_types.JSONB(), nullable=True, comment="{ monday: { open: '09:00', close: '18:00' }, ... }"),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['manager_id'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('branches', schema=None) as batch_op:
        batch_op.create_index('idx_branch_active', ['is_active'], unique=False)
        batch_op.create_index('idx_branch_code', ['code'], unique=False)
        batch_op.create_index('idx_branch_org', ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_branches_code'), ['code'], unique=True)
        batch_op.create_index(batch_op.f('ix_branches_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_branches_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_branches_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_branches_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_branches_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_branches_updated_at'), ['updated_at'], unique=False)

    op.create_table('drug_categories',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('parent_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('path', sa.String(length=500), nullable=True, comment='Materialized path like /electronics/computers/laptops/'),
    sa.Column('level', sa.Integer(), nullable=False, comment='Depth in hierarchy (0 = root)'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['parent_id'], ['drug_categories.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('drug_categories', schema=None) as batch_op:
        batch_op.create_index('idx_category_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_category_parent', ['parent_id'], unique=False)
        batch_op.create_index('idx_category_path', ['path'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_categories_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_categories_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_categories_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_categories_parent_id'), ['parent_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_categories_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_categories_updated_at'), ['updated_at'], unique=False)

    op.create_table('insurance_providers',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False, comment='Insurance company name: GLICO, SIC, Enterprise, etc.'),
    sa.Column('code', sa.String(length=50), nullable=False, comment='Short code: GLICO, SIC, ENT'),
    sa.Column('logo_url', sa.Text(), nullable=True, comment='URL to insurance company logo'),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('website', sa.String(length=255), nullable=True),
    sa.Column('address', app.models.db_types.JSONB(), nullable=True, comment='Insurance company address'),
    sa.Column('primary_contact_name', sa.String(length=255), nullable=True),
    sa.Column('primary_contact_phone', sa.String(length=20), nullable=True),
    sa.Column('primary_contact_email', sa.String(length=255), nullable=True),
    sa.Column('billing_cycle', sa.String(length=50), nullable=False, comment='daily, weekly, monthly, quarterly'),
    sa.Column('payment_terms', sa.String(length=50), nullable=False, comment='NET15, NET30, NET60, etc.'),
    sa.Column('requires_card_verification', sa.Boolean(), nullable=False, comment='Require insurance card scan/verification'),
    sa.Column('requires_preauth', sa.Boolean(), nullable=False, comment='Require pre-authorization for claims'),
    sa.Column('verification_endpoint', sa.Text(), nullable=True, comment='API endpoint for real-time eligibility verification'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.CheckConstraint("billing_cycle IN ('daily', 'weekly', 'monthly', 'quarterly', 'annually')", name='check_billing_cycle'),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('insurance_providers', schema=None) as batch_op:
        batch_op.create_index('idx_insurance_active', ['is_active'], unique=False)
        batch_op.create_index('idx_insurance_code', ['code'], unique=False)
        batch_op.create_index('idx_insurance_org', ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_insurance_providers_code'), ['code'], unique=True)
        batch_op.create_index(batch_op.f('ix_insurance_providers_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_insurance_providers_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_insurance_providers_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_insurance_providers_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_insurance_providers_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_insurance_providers_updated_at'), ['updated_at'], unique=False)

    op.create_table('suppliers',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('contact_person', sa.String(length=255), nullable=True),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('address', app.models.db_types.JSONB(), nullable=True),
    sa.Column('tax_id', sa.String(length=50), nullable=True),
    sa.Column('registration_number', sa.String(length=100), nullable=True),
    sa.Column('payment_terms', sa.String(length=100), nullable=True, comment='NET30, NET60, COD, etc.'),
    sa.Column('credit_limit', sa.Numeric(precision=12, scale=2), nullable=True),
    sa.Column('rating', sa.Numeric(precision=3, scale=2), nullable=True, comment='Supplier rating 0.00-5.00'),
    sa.Column('total_orders', sa.Integer(), nullable=False),
    sa.Column('total_value', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.CheckConstraint('rating IS NULL OR (rating >= 0 AND rating <= 5)', name='check_supplier_rating'),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('suppliers', schema=None) as batch_op:
        batch_op.create_index('idx_supplier_active', ['is_active'], unique=False)
        batch_op.create_index('idx_supplier_org', ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_name'), ['name'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_suppliers_updated_at'), ['updated_at'], unique=False)

    op.create_table('user_sessions',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('user_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('token_hash', sa.String(length=255), nullable=False),
    sa.Column('refresh_token_hash', sa.String(length=255), nullable=True),
    sa.Column('ip_address', app.models.db_types.INET(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('is_revoked', sa.Boolean(), nullable=False),
    sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('user_sessions', schema=None) as batch_op:
        batch_op.create_index('idx_session_active', ['is_revoked', 'expires_at'], unique=False)
        batch_op.create_index('idx_session_expires', ['expires_at'], unique=False)
        batch_op.create_index('idx_session_token', ['token_hash'], unique=False)
        batch_op.create_index('idx_session_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_sessions_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_sessions_expires_at'), ['expires_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_sessions_is_revoked'), ['is_revoked'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_sessions_refresh_token_hash'), ['refresh_token_hash'], unique=True)
        batch_op.create_index(batch_op.f('ix_user_sessions_token_hash'), ['token_hash'], unique=True)
        batch_op.create_index(batch_op.f('ix_user_sessions_updated_at'), ['updated_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_sessions_user_id'), ['user_id'], unique=False)

    op.create_table('drugs',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False, comment='Brand or trade name'),
    sa.Column('generic_name', sa.String(length=255), nullable=True, comment='Generic/scientific name'),
    sa.Column('brand_name', sa.String(length=255), nullable=True),
    sa.Column('sku', sa.String(length=100), nullable=True, comment='Stock Keeping Unit'),
    sa.Column('barcode', sa.String(length=100), nullable=True, comment='EAN, UPC, or other barcode'),
    sa.Column('category_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('drug_type', sa.String(length=50), nullable=False, comment='prescription, otc, controlled, herbal, supplement'),
    sa.Column('dosage_form', sa.String(length=100), nullable=True, comment='tablet, capsule, syrup, injection, cream, etc.'),
    sa.Column('strength', sa.String(length=100), nullable=True, comment='e.g., 500mg, 10mg/ml'),
    sa.Column('manufacturer', sa.String(length=255), nullable=True),
    sa.Column('supplier', sa.String(length=255), nullable=True),
    sa.Column('ndc_code', sa.String(length=50), nullable=True, comment='National Drug Code (US)'),
    sa.Column('requires_prescription', sa.Boolean(), nullable=False),
    sa.Column('controlled_substance_schedule', sa.String(length=10), nullable=True, comment='DEA Schedule I-V for controlled substances'),
    sa.Column('unit_price', sa.Numeric(precision=10, scale=2), nullable=False, comment='Selling price per unit'),
    sa.Column('cost_price', sa.Numeric(precision=10, scale=2), nullable=True, comment='Cost/acquisition price per unit'),
    sa.Column('markup_percentage', sa.Numeric(precision=5, scale=2), nullable=True, comment='Profit margin percentage'),
    sa.Column('tax_rate', sa.Numeric(precision=5, scale=2), nullable=False, comment='Tax rate as percentage'),
    sa.Column('reorder_level', sa.Integer(), nullable=False, comment='Trigger reorder alert when stock falls below'),
    sa.Column('reorder_quantity', sa.Integer(), nullable=False, comment='Suggested reorder quantity'),
    sa.Column('max_stock_level', sa.Integer(), nullable=True, comment='Maximum stock to maintain'),
    sa.Column('unit_of_measure', sa.String(length=50), nullable=False, comment='unit, box, bottle, strip, etc.'),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('usage_instructions', sa.Text(), nullable=True),
    sa.Column('side_effects', sa.Text(), nullable=True),
    sa.Column('contraindications', sa.Text(), nullable=True),
    sa.Column('storage_conditions', sa.Text(), nullable=True),
    sa.Column('image_url', sa.Text(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('search_vector', sa.Text(), nullable=True, comment='Generated tsvector for full-text search'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.CheckConstraint("drug_type IN ('prescription', 'otc', 'controlled', 'herbal', 'supplement')", name='check_drug_type'),
    sa.CheckConstraint('cost_price IS NULL OR cost_price >= 0', name='check_cost_price_positive'),
    sa.CheckConstraint('unit_price >= 0', name='check_unit_price_positive'),
    sa.ForeignKeyConstraint(['category_id'], ['drug_categories.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('drugs', schema=None) as batch_op:
        batch_op.create_index('idx_drug_active', ['is_active'], unique=False)
        batch_op.create_index('idx_drug_barcode', ['barcode'], unique=False)
        batch_op.create_index('idx_drug_category', ['category_id'], unique=False)
        batch_op.create_index('idx_drug_generic', ['generic_name'], unique=False)
        batch_op.create_index('idx_drug_name', ['name'], unique=False)
        batch_op.create_index('idx_drug_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_drug_org_active', ['organization_id', 'is_active'], unique=False)
        batch_op.create_index('idx_drug_org_type', ['organization_id', 'drug_type'], unique=False)
        batch_op.create_index('idx_drug_search', ['search_vector'], unique=False, postgresql_using='gin')
        batch_op.create_index('idx_drug_sku', ['sku'], unique=False)
        batch_op.create_index('idx_drug_sync', ['sync_status', 'sync_version'], unique=False)
        batch_op.create_index('idx_drug_type', ['drug_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_barcode'), ['barcode'], unique=True)
        batch_op.create_index(batch_op.f('ix_drugs_category_id'), ['category_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_drug_type'), ['drug_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_generic_name'), ['generic_name'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_name'), ['name'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_requires_prescription'), ['requires_prescription'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_sku'), ['sku'], unique=True)
        batch_op.create_index(batch_op.f('ix_drugs_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_unit_price'), ['unit_price'], unique=False)
        batch_op.create_index(batch_op.f('ix_drugs_updated_at'), ['updated_at'], unique=False)

    op.create_table('price_contracts',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('contract_code', sa.String(length=50), nullable=False, comment='Unique code: GLICO-STD, SIC-PREM, STAFF-20, STANDARD'),
    sa.Column('contract_name', sa.String(length=255), nullable=False, comment="Display name: 'GLICO Insurance Standard Plan'"),
    sa.Column('description', sa.Text(), nullable=True, comment='Contract terms and conditions'),
    sa.Column('contract_type', sa.String(length=50), nullable=False, comment='insurance, corporate, staff, senior_citizen, standard, wholesale'),
    sa.Column('is_default_contract', sa.Boolean(), nullable=False, comment="TRUE for 'Standard Pricing' contract used as fallback"),
    sa.Column('discount_type', sa.String(length=50), nullable=False, comment='percentage, fixed_amount, custom'),
    sa.Column('discount_percentage', sa.Numeric(precision=5, scale=2), nullable=False, comment='Discount percentage: 5.00, 10.00, 15.00, 20.00'),
    sa.Column('applies_to_prescription_only', sa.Boolean(), nullable=False, comment='If TRUE, contract only applies to prescription drugs'),
    sa.Column('applies_to_otc', sa.Boolean(), nullable=False, comment='If TRUE, contract applies to over-the-counter drugs'),
    sa.Column('excluded_drug_categories', app.models.db_types.ARRAY(), nullable=False, comment='Categories excluded from this contract (e.g., controlled substances)'),
    sa.Column('excluded_drug_ids', app.models.db_types.ARRAY(), nullable=False, comment='Specific drugs excluded from contract'),
    sa.Column('minimum_price_override', sa.Numeric(precision=10, scale=2), nullable=True, comment='Never go below this price even with discount'),
    sa.Column('maximum_discount_amount', sa.Numeric(precision=10, scale=2), nullable=True, comment='Cap the discount amount per item'),
    sa.Column('applies_to_all_branches', sa.Boolean(), nullable=False, comment='If FALSE, only specific branches can use this contract'),
    sa.Column('applicable_branch_ids', app.models.db_types.ARRAY(), nullable=False, comment='Specific branches where this contract is valid'),
    sa.Column('effective_from', sa.Date(), nullable=False, comment='Contract start date'),
    sa.Column('effective_to', sa.Date(), nullable=True, comment='Contract end date (NULL = no expiry)'),
    sa.Column('requires_verification', sa.Boolean(), nullable=False, comment='Require verification (e.g., insurance card scan) before applying'),
    sa.Column('requires_approval', sa.Boolean(), nullable=False, comment='Require manager approval during checkout'),
    sa.Column('allowed_user_roles', app.models.db_types.ARRAY(), nullable=False, comment="User roles allowed to apply this contract: ['pharmacist', 'cashier', 'manager']"),
    sa.Column('insurance_provider_id', app.models.db_types.UUID(length=36), nullable=True, comment="Link to insurance provider if contract_type = 'insurance'"),
    sa.Column('copay_amount', sa.Numeric(precision=10, scale=2), nullable=True, comment='Fixed copay amount patient must pay'),
    sa.Column('copay_percentage', sa.Numeric(precision=5, scale=2), nullable=True, comment='Percentage of price patient must pay'),
    sa.Column('created_by', app.models.db_types.UUID(length=36), nullable=False, comment='User who created the contract'),
    sa.Column('approved_by', app.models.db_types.UUID(length=36), nullable=True, comment='Manager who approved the contract'),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False, comment='draft, active, suspended, expired, cancelled'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('total_transactions', sa.Integer(), nullable=False, comment='Total sales using this contract'),
    sa.Column('total_discount_given', sa.Numeric(precision=12, scale=2), nullable=False, comment='Total discount amount given under this contract'),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True, comment='Last time this contract was used'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.CheckConstraint("contract_type IN ('insurance', 'corporate', 'staff', 'senior_citizen', 'standard', 'wholesale', 'government')", name='check_contract_type'),
    sa.CheckConstraint("discount_type IN ('percentage', 'fixed_amount', 'custom')", name='check_discount_type'),
    sa.CheckConstraint("status IN ('draft', 'active', 'suspended', 'expired', 'cancelled')", name='check_contract_status'),
    sa.CheckConstraint('discount_percentage >= 0 AND discount_percentage <= 100', name='check_discount_percentage_range'),
    sa.CheckConstraint('effective_to IS NULL OR effective_to >= effective_from', name='check_contract_dates'),
    sa.ForeignKeyConstraint(['approved_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['insurance_provider_id'], ['insurance_providers.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'contract_code', name='uq_org_contract_code')
    )
    with op.batch_alter_table('price_contracts', schema=None) as batch_op:
        batch_op.create_index('idx_contract_active_dates', ['organization_id', 'is_active', 'status', 'effective_from', 'effective_to'], unique=False, postgresql_where="is_active = TRUE AND status = 'active'")
        batch_op.create_index('idx_contract_code', ['contract_code'], unique=False)
        batch_op.create_index('idx_contract_dates', ['effective_from', 'effective_to'], unique=False)
        batch_op.create_index('idx_contract_default_unique', ['organization_id', 'is_default_contract'], unique=True, postgresql_where='is_default_contract = TRUE')
        batch_op.create_index('idx_contract_insurance', ['insurance_provider_id'], unique=False)
        batch_op.create_index('idx_contract_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_contract_status', ['status', 'is_active'], unique=False)
        batch_op.create_index('idx_contract_type', ['contract_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_applies_to_all_branches'), ['applies_to_all_branches'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_contract_code'), ['contract_code'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_contract_type'), ['contract_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_effective_from'), ['effective_from'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_effective_to'), ['effective_to'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_insurance_provider_id'), ['insurance_provider_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_is_default_contract'), ['is_default_contract'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contracts_updated_at'), ['updated_at'], unique=False)

    op.create_table('purchase_orders',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('branch_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('po_number', sa.String(length=50), nullable=False),
    sa.Column('supplier_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('subtotal', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('tax_amount', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('shipping_cost', sa.Numeric(precision=10, scale=2), nullable=False),
    sa.Column('total_amount', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False, comment='draft, pending, approved, ordered, received, cancelled'),
    sa.Column('ordered_by', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('approved_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('expected_delivery_date', sa.Date(), nullable=True),
    sa.Column('received_date', sa.Date(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.CheckConstraint("status IN ('draft', 'pending', 'approved', 'ordered', 'received', 'cancelled')", name='check_po_status'),
    sa.ForeignKeyConstraint(['approved_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['branch_id'], ['branches.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['ordered_by'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['supplier_id'], ['suppliers.id'], ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('purchase_orders', schema=None) as batch_op:
        batch_op.create_index('idx_po_branch', ['branch_id'], unique=False)
        batch_op.create_index('idx_po_expected_delivery', ['expected_delivery_date'], unique=False)
        batch_op.create_index('idx_po_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_po_status', ['status'], unique=False)
        batch_op.create_index('idx_po_supplier', ['supplier_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_branch_id'), ['branch_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_expected_delivery_date'), ['expected_delivery_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_po_number'), ['po_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_purchase_orders_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_supplier_id'), ['supplier_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_orders_updated_at'), ['updated_at'], unique=False)

    op.create_table('branch_inventory',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('branch_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('quantity', sa.Integer(), nullable=False, comment='Total available quantity'),
    sa.Column('reserved_quantity', sa.Integer(), nullable=False, comment='Reserved for pending orders/prescriptions'),
    sa.Column('location', sa.String(length=100), nullable=True, comment='Shelf/bin location in warehouse'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.CheckConstraint('quantity >= 0', name='check_quantity_nonnegative'),
    sa.CheckConstraint('reserved_quantity <= quantity', name='check_reserved_lte_quantity'),
    sa.CheckConstraint('reserved_quantity >= 0', name='check_reserved_nonnegative'),
    sa.ForeignKeyConstraint(['branch_id'], ['branches.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('branch_id', 'drug_id', name='uq_branch_drug')
    )
    with op.batch_alter_table('branch_inventory', schema=None) as batch_op:
        batch_op.create_index('idx_inventory_branch', ['branch_id'], unique=False)
        batch_op.create_index('idx_inventory_drug', ['drug_id'], unique=False)
        batch_op.create_index('idx_inventory_quantity', ['quantity'], unique=False)
        batch_op.create_index('idx_inventory_sync', ['sync_status', 'sync_version'], unique=False)
        batch_op.create_index(batch_op.f('ix_branch_inventory_branch_id'), ['branch_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_branch_inventory_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_branch_inventory_drug_id'), ['drug_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_branch_inventory_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_branch_inventory_updated_at'), ['updated_at'], unique=False)

    op.create_table('customers',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('customer_type', sa.String(length=50), nullable=False, comment='walk_in, registered, insurance, corporate'),
    sa.Column('first_name', sa.String(length=255), nullable=True),
    sa.Column('last_name', sa.String(length=255), nullable=True),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('date_of_birth', sa.Date(), nullable=True),
    sa.Column('address', app.models.db_types.JSONB(), nullable=True, comment='{ street, city, state, zip, country }'),
    sa.Column('allergies', app.models.db_types.ARRAY(), nullable=False, comment='Known drug allergies'),
    sa.Column('chronic_conditions', app.models.db_types.ARRAY(), nullable=False, comment='Chronic medical conditions'),
    sa.Column('medical_data_encrypted', sa.Boolean(), nullable=False, comment='Whether PHI is encrypted'),
    sa.Column('loyalty_points', sa.Integer(), nullable=False),
    sa.Column('loyalty_tier', sa.String(length=50), nullable=False, comment='bronze, silver, gold, platinum'),
    sa.Column('preferred_contact_method', sa.String(length=20), nullable=False, comment='email, phone, sms'),
    sa.Column('marketing_consent', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('insurance_provider_id', app.models.db_types.UUID(length=36), nullable=True, comment="Customer's insurance provider"),
    sa.Column('insurance_member_id', sa.String(length=100), nullable=True, comment='Member/policy ID with insurance company'),
    sa.Column('insurance_card_image_url', sa.Text(), nullable=True, comment='Scanned insurance card for verification'),
    sa.Column('insurance_verified', sa.Boolean(), nullable=False, comment='Whether insurance has been verified'),
    sa.Column('insurance_verified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('preferred_contract_id', app.models.db_types.UUID(length=36), nullable=True, comment="Customer's preferred pricing contract (for corporate/staff)"),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.CheckConstraint("customer_type IN ('walk_in', 'registered', 'insurance', 'corporate')", name='check_customer_type'),
    sa.CheckConstraint("loyalty_tier IN ('bronze', 'silver', 'gold', 'platinum')", name='check_loyalty_tier'),
    sa.ForeignKeyConstraint(['deleted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['insurance_provider_id'], ['insurance_providers.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['preferred_contract_id'], ['price_contracts.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('customers', schema=None) as batch_op:
        batch_op.create_index('idx_customer_email', ['email'], unique=False)
        batch_op.create_index('idx_customer_loyalty', ['loyalty_points', 'loyalty_tier'], unique=False)
        batch_op.create_index('idx_customer_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_customer_phone', ['phone'], unique=False)
        batch_op.create_index('idx_customer_type', ['customer_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_customer_type'), ['customer_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_email'), ['email'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_insurance_member_id'), ['insurance_member_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_insurance_provider_id'), ['insurance_provider_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_is_deleted'), ['is_deleted'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_phone'), ['phone'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_customers_updated_at'), ['updated_at'], unique=False)

    op.create_table('drug_batches',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('branch_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('batch_number', sa.String(length=100), nullable=False, comment="Manufacturer's batch/lot number"),
    sa.Column('quantity', sa.Integer(), nullable=False, comment='Initial quantity received'),
    sa.Column('remaining_quantity', sa.Integer(), nullable=False, comment='Current remaining quantity'),
    sa.Column('manufacturing_date', sa.Date(), nullable=True),
    sa.Column('expiry_date', sa.Date(), nullable=False, comment='Expiration date - critical for safety'),
    sa.Column('cost_price', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('selling_price', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('supplier', sa.String(length=255), nullable=True),
    sa.Column('purchase_order_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.CheckConstraint('remaining_quantity <= quantity', name='check_batch_remaining_lte_total'),
    sa.CheckConstraint('remaining_quantity >= 0', name='check_batch_remaining'),
    sa.ForeignKeyConstraint(['branch_id'], ['branches.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['purchase_order_id'], ['purchase_orders.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('branch_id', 'drug_id', 'batch_number', name='uq_branch_drug_batch')
    )
    with op.batch_alter_table('drug_batches', schema=None) as batch_op:
        batch_op.create_index('idx_batch_branch', ['branch_id'], unique=False)
        batch_op.create_index('idx_batch_drug', ['drug_id'], unique=False)
        batch_op.create_index('idx_batch_expiring_stock', ['expiry_date', 'remaining_quantity'], unique=False, postgresql_where=sa.text('remaining_quantity > 0'))
        batch_op.create_index('idx_batch_expiry', ['expiry_date'], unique=False)
        batch_op.create_index('idx_batch_remaining', ['remaining_quantity'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_batch_number'), ['batch_number'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_branch_id'), ['branch_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_drug_id'), ['drug_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_expiry_date'), ['expiry_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_drug_batches_updated_at'), ['updated_at'], unique=False)

    op.create_table('price_contract_items',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('contract_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('override_discount_percentage', sa.Numeric(precision=5, scale=2), nullable=True, comment="Override the contract's default discount for this drug"),
    sa.Column('fixed_price', sa.Numeric(precision=10, scale=2), nullable=True, comment='Set a fixed price for this drug (ignores base price and discount)'),
    sa.Column('is_excluded', sa.Boolean(), nullable=False, comment='Exclude this drug from contract (0% discount)'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.CheckConstraint('override_discount_percentage IS NULL OR (override_discount_percentage >= 0 AND override_discount_percentage <= 100)', name='check_override_discount'),
    sa.ForeignKeyConstraint(['contract_id'], ['price_contracts.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('contract_id', 'drug_id', name='uq_contract_drug')
    )
    with op.batch_alter_table('price_contract_items', schema=None) as batch_op:
        batch_op.create_index('idx_contract_item_contract', ['contract_id'], unique=False)
        batch_op.create_index('idx_contract_item_drug', ['drug_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contract_items_contract_id'), ['contract_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contract_items_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contract_items_drug_id'), ['drug_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_price_contract_items_updated_at'), ['updated_at'], unique=False)

    op.create_table('purchase_order_items',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('purchase_order_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('quantity_ordered', sa.Integer(), nullable=False),
    sa.Column('quantity_received', sa.Integer(), nullable=False),
    sa.Column('unit_cost', sa.Numeric(precision=10, scale=2), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('batch_number', sa.String(length=100), nullable=True),
    sa.Column('expiry_date', sa.Date(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.CheckConstraint('quantity_ordered > 0', name='check_po_item_quantity'),
    sa.CheckConstraint('quantity_received <= quantity_ordered', name='check_po_item_received_max'),
    sa.CheckConstraint('quantity_received >= 0', name='check_po_item_received'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['purchase_order_id'], ['purchase_orders.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('purchase_order_items', schema=None) as batch_op:
        batch_op.create_index('idx_po_item_drug', ['drug_id'], unique=False)
        batch_op.create_index('idx_po_item_po', ['purchase_order_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_order_items_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_order_items_purchase_order_id'), ['purchase_order_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_purchase_order_items_updated_at'), ['updated_at'], unique=False)

    op.create_table('stock_adjustments',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('branch_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('adjustment_type', sa.String(length=50), nullable=False, comment='damage, expired, theft, return, correction, transfer'),
    sa.Column('quantity_change', sa.Integer(), nullable=False, comment='Positive for additions, negative for reductions'),
    sa.Column('previous_quantity', sa.Integer(), nullable=False),
    sa.Column('new_quantity', sa.Integer(), nullable=False),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('adjusted_by', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('transfer_to_branch_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.CheckConstraint("adjustment_type IN ('damage', 'expired', 'theft', 'return', 'correction', 'transfer')", name='check_adjustment_type'),
    sa.CheckConstraint('new_quantity >= 0', name='check_new_quantity'),
    sa.ForeignKeyConstraint(['adjusted_by'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['branch_id'], ['branches.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['transfer_to_branch_id'], ['branches.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('stock_adjustments', schema=None) as batch_op:
        batch_op.create_index('idx_adjustment_branch', ['branch_id'], unique=False)
        batch_op.create_index('idx_adjustment_date', ['created_at'], unique=False)
        batch_op.create_index('idx_adjustment_drug', ['drug_id'], unique=False)
        batch_op.create_index('idx_adjustment_type', ['adjustment_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_adjustments_adjusted_by'), ['adjusted_by'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_adjustments_adjustment_type'), ['adjustment_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_adjustments_branch_id'), ['branch_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_adjustments_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_adjustments_drug_id'), ['drug_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_adjustments_updated_at'), ['updated_at'], unique=False)

    op.create_table('system_alerts',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('branch_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('alert_type', sa.String(length=50), nullable=False, comment='low_stock, expiry_warning, out_of_stock, system_error, security'),
    sa.Column('severity', sa.String(length=20), nullable=False, comment='low, medium, high, critical'),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('is_resolved', sa.Boolean(), nullable=False),
    sa.Column('resolved_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('resolved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('resolution_notes', sa.Text(), nullable=True),
    sa.Column('notifications_sent', app.models.db_types.ARRAY(), nullable=False, comment='List of notification channels used: email, sms, push'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.CheckConstraint("alert_type IN ('low_stock', 'expiry_warning', 'out_of_stock', 'system_error', 'security')", name='check_alert_type'),
    sa.CheckConstraint("severity IN ('low', 'medium', 'high', 'critical')", name='check_alert_severity'),
    sa.ForeignKeyConstraint(['branch_id'], ['branches.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['resolved_by'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('system_alerts', schema=None) as batch_op:
        batch_op.create_index('idx_alert_branch', ['branch_id'], unique=False)
        batch_op.create_index('idx_alert_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_alert_resolved', ['is_resolved'], unique=False)
        batch_op.create_index('idx_alert_severity', ['severity'], unique=False)
        batch_op.create_index('idx_alert_type', ['alert_type'], unique=False)
        batch_op.create_index('idx_alert_unresolved', ['organization_id', 'is_resolved'], unique=False, postgresql_where=sa.text('is_resolved = false'))
        batch_op.create_index(batch_op.f('ix_system_alerts_alert_type'), ['alert_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_alerts_branch_id'), ['branch_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_alerts_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_alerts_is_resolved'), ['is_resolved'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_alerts_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_alerts_severity'), ['severity'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_alerts_updated_at'), ['updated_at'], unique=False)

    op.create_table('prescriptions',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('prescription_number', sa.String(length=100), nullable=False),
    sa.Column('customer_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('prescriber_name', sa.String(length=255), nullable=False),
    sa.Column('prescriber_license', sa.String(length=100), nullable=False),
    sa.Column('prescriber_phone', sa.String(length=20), nullable=True),
    sa.Column('prescriber_address', sa.Text(), nullable=True),
    sa.Column('issue_date', sa.Date(), nullable=False),
    sa.Column('expiry_date', sa.Date(), nullable=False),
    sa.Column('medications', app.models.db_types.JSONB(), nullable=False, comment='Array of { drug_id, drug_name, dosage, frequency, duration, quantity }'),
    sa.Column('diagnosis', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('special_instructions', sa.Text(), nullable=True),
    sa.Column('refills_allowed', sa.Integer(), nullable=False),
    sa.Column('refills_remaining', sa.Integer(), nullable=False),
    sa.Column('last_refill_date', sa.Date(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False, comment='active, filled, expired, cancelled'),
    sa.Column('verified_by', app.models.db_types.UUID(length=36), nullable=True, comment='Pharmacist who verified prescription'),
    sa.Column('verified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.CheckConstraint("status IN ('active', 'filled', 'expired', 'cancelled')", name='check_prescription_status'),
    sa.CheckConstraint('refills_remaining <= refills_allowed', name='check_refills_valid'),
    sa.CheckConstraint('refills_remaining >= 0', name='check_refills_remaining'),
    sa.ForeignKeyConstraint(['customer_id'], ['customers.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['verified_by'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('prescriptions', schema=None) as batch_op:
        batch_op.create_index('idx_prescription_customer', ['customer_id'], unique=False)
        batch_op.create_index('idx_prescription_expiry', ['expiry_date'], unique=False)
        batch_op.create_index('idx_prescription_issue_date', ['issue_date'], unique=False)
        batch_op.create_index('idx_prescription_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_prescription_status', ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_customer_id'), ['customer_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_expiry_date'), ['expiry_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_issue_date'), ['issue_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_prescription_number'), ['prescription_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_prescriptions_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_prescriptions_updated_at'), ['updated_at'], unique=False)

    op.create_table('sales',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('organization_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('branch_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('sale_number', sa.String(length=50), nullable=False, comment='Human-readable sale number like BR001-20260112-0001'),
    sa.Column('customer_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('customer_name', sa.String(length=255), nullable=True, comment='For walk-in customers without registration'),
    sa.Column('subtotal', sa.Numeric(precision=10, scale=2), nullable=False, comment='Sum of all items before discount and tax'),
    sa.Column('discount_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total discount applied'),
    sa.Column('tax_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total tax charged'),
    sa.Column('total_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Final amount to be paid'),
    sa.Column('payment_method', sa.String(length=50), nullable=False, comment='cash, card, mobile_money, insurance, credit'),
    sa.Column('payment_status', sa.String(length=50), nullable=False, comment='pending, completed, partial, refunded, cancelled'),
    sa.Column('amount_paid', sa.Numeric(precision=10, scale=2), nullable=True, comment='Actual amount paid by customer'),
    sa.Column('change_amount', sa.Numeric(precision=10, scale=2), nullable=True, comment='Change given to customer'),
    sa.Column('payment_reference', sa.String(length=255), nullable=True, comment='Transaction ID from payment gateway'),
    sa.Column('prescription_id', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('prescription_number', sa.String(length=100), nullable=True),
    sa.Column('prescriber_name', sa.String(length=255), nullable=True),
    sa.Column('prescriber_license', sa.String(length=100), nullable=True),
    sa.Column('cashier_id', app.models.db_types.UUID(length=36), nullable=False, comment='User who processed the sale'),
    sa.Column('pharmacist_id', app.models.db_types.UUID(length=36), nullable=True, comment='Pharmacist who verified prescription'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False, comment='draft, completed, cancelled, refunded'),
    sa.Column('cancelled_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('cancelled_by', app.models.db_types.UUID(length=36), nullable=True),
    sa.Column('cancellation_reason', sa.Text(), nullable=True),
    sa.Column('refund_amount', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('refunded_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('receipt_printed', sa.Boolean(), nullable=False),
    sa.Column('receipt_emailed', sa.Boolean(), nullable=False),
    sa.Column('price_contract_id', app.models.db_types.UUID(length=36), nullable=True, comment='Price contract applied to this sale'),
    sa.Column('contract_discount_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total discount from contract pricing'),
    sa.Column('additional_discount_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Additional manual discounts beyond contract'),
    sa.Column('insurance_claim_number', sa.String(length=100), nullable=True, comment='Insurance claim reference number'),
    sa.Column('patient_copay_amount', sa.Numeric(precision=10, scale=2), nullable=True, comment='Amount patient paid (copay)'),
    sa.Column('insurance_covered_amount', sa.Numeric(precision=10, scale=2), nullable=True, comment='Amount covered by insurance'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('sync_version', sa.BigInteger(), nullable=False, comment='Incremented on each update for conflict detection'),
    sa.Column('sync_status', sa.String(length=20), nullable=False, comment='synced, pending, conflict, deleted'),
    sa.Column('last_synced_at', sa.DateTime(timezone=True), nullable=True, comment='Last successful sync with server'),
    sa.Column('sync_hash', sa.String(length=64), nullable=True, comment='SHA256 hash for detecting changes'),
    sa.CheckConstraint("payment_method IN ('cash', 'card', 'mobile_money', 'insurance', 'credit', 'split')", name='check_payment_method'),
    sa.CheckConstraint("payment_status IN ('pending', 'completed', 'partial', 'refunded', 'cancelled')", name='check_payment_status'),
    sa.CheckConstraint("status IN ('draft', 'completed', 'cancelled', 'refunded')", name='check_sale_status'),
    sa.CheckConstraint('discount_amount >= 0', name='check_discount'),
    sa.CheckConstraint('subtotal >= 0', name='check_subtotal'),
    sa.CheckConstraint('total_amount >= 0', name='check_total_amount'),
    sa.ForeignKeyConstraint(['branch_id'], ['branches.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['cancelled_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['cashier_id'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['customer_id'], ['customers.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['pharmacist_id'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['prescription_id'], ['prescriptions.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['price_contract_id'], ['price_contracts.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('sales', schema=None) as batch_op:
        batch_op.create_index('idx_sale_branch', ['branch_id'], unique=False)
        batch_op.create_index('idx_sale_branch_date', ['branch_id', 'created_at'], unique=False)
        batch_op.create_index('idx_sale_cashier', ['cashier_id'], unique=False)
        batch_op.create_index('idx_sale_customer', ['customer_id'], unique=False)
        batch_op.create_index('idx_sale_date', ['created_at'], unique=False)
        batch_op.create_index('idx_sale_number', ['sale_number'], unique=False)
        batch_op.create_index('idx_sale_org', ['organization_id'], unique=False)
        batch_op.create_index('idx_sale_org_date', ['organization_id', 'created_at'], unique=False)
        batch_op.create_index('idx_sale_status', ['status'], unique=False)
        batch_op.create_index('idx_sale_status_date', ['status', 'created_at'], unique=False)
        batch_op.create_index('idx_sale_sync', ['sync_status', 'sync_version'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_branch_id'), ['branch_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_cashier_id'), ['cashier_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_customer_id'), ['customer_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_organization_id'), ['organization_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_payment_method'), ['payment_method'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_payment_status'), ['payment_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_price_contract_id'), ['price_contract_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_sale_number'), ['sale_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_sales_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_sync_status'), ['sync_status'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_total_amount'), ['total_amount'], unique=False)
        batch_op.create_index(batch_op.f('ix_sales_updated_at'), ['updated_at'], unique=False)

    op.create_table('sale_items',
    sa.Column('id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('sale_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_id', app.models.db_types.UUID(length=36), nullable=False),
    sa.Column('drug_name', sa.String(length=255), nullable=False, comment='Drug name at time of sale'),
    sa.Column('batch_number', sa.String(length=100), nullable=True),
    sa.Column('base_price', sa.Numeric(precision=10, scale=2), nullable=False, comment='Original drug price (before contract)'),
    sa.Column('contract_price', sa.Numeric(precision=10, scale=2), nullable=True, comment='Price after applying contract discount'),
    sa.Column('contract_discount_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Discount amount from contract'),
    sa.Column('applied_contract_id', app.models.db_types.UUID(length=36), nullable=True, comment='Contract used for pricing this item'),
    sa.Column('quantity', sa.Integer(), nullable=False, comment='Number of units sold'),
    sa.Column('unit_of_measure', sa.String(length=50), nullable=False),
    sa.Column('unit_price', sa.Numeric(precision=10, scale=2), nullable=False, comment='Price per unit at time of sale'),
    sa.Column('subtotal', sa.Numeric(precision=10, scale=2), nullable=False, comment='quantity * unit_price'),
    sa.Column('discount_percentage', sa.Numeric(precision=5, scale=2), nullable=False),
    sa.Column('discount_amount', sa.Numeric(precision=10, scale=2), nullable=False),
    sa.Column('tax_rate', sa.Numeric(precision=5, scale=2), nullable=False),
    sa.Column('tax_amount', sa.Numeric(precision=10, scale=2), nullable=False),
    sa.Column('total_price', sa.Numeric(precision=10, scale=2), nullable=False, comment='Final price for this item (quantity * unit_price - discount + tax)'),
    sa.Column('requires_prescription', sa.Boolean(), nullable=False),
    sa.Column('prescription_verified', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.CheckConstraint('quantity > 0', name='check_sale_item_quantity'),
    sa.CheckConstraint('total_price >= 0', name='check_sale_item_total'),
    sa.CheckConstraint('unit_price >= 0', name='check_sale_item_price'),
    sa.ForeignKeyConstraint(['applied_contract_id'], ['price_contracts.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['drug_id'], ['drugs.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['sale_id'], ['sales.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('sale_items', schema=None) as batch_op:
        batch_op.create_index('idx_sale_item_date', ['created_at'], unique=False)
        batch_op.create_index('idx_sale_item_drug', ['drug_id'], unique=False)
        batch_op.create_index('idx_sale_item_sale', ['sale_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sale_items_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_sale_items_drug_id'), ['drug_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sale_items_sale_id'), ['sale_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sale_items_updated_at'), ['updated_at'], unique=False)

    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('sale_items', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_sale_items_updated_at'))
        batch_op.drop_index(batch_op.f('ix_sale_items_sale_id'))
        batch_op.drop_index(batch_op.f('ix_sale_items_drug_id'))
        batch_op.drop_index(batch_op.f('ix_sale_items_created_at'))
        batch_op.drop_index('idx_sale_item_sale')
        batch_op.drop_index('idx_sale_item_drug')
        batch_op.drop_index('idx_sale_item_date')

    op.drop_table('sale_items')
    with op.batch_alter_table('sales', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_sales_updated_at'))
        batch_op.drop_index(batch_op.f('ix_sales_total_amount'))
        batch_op.drop_index(batch_op.f('ix_sales_sync_status'))
        batch_op.drop_index(batch_op.f('ix_sales_status'))
        batch_op.drop_index(batch_op.f('ix_sales_sale_number'))
        batch_op.drop_index(batch_op.f('ix_sales_price_contract_id'))
        batch_op.drop_index(batch_op.f('ix_sales_payment_status'))
        batch_op.drop_index(batch_op.f('ix_sales_payment_method'))
        batch_op.drop_index(batch_op.f('ix_sales_organization_id'))
        batch_op.drop_index(batch_op.f('ix_sales_customer_id'))
        batch_op.drop_index(batch_op.f('ix_sales_created_at'))
        batch_op.drop_index(batch_op.f('ix_sales_cashier_id'))
        batch_op.drop_index(batch_op.f('ix_sales_branch_id'))
        batch_op.drop_index('idx_sale_sync')
        batch_op.drop_index('idx_sale_status_date')
        batch_op.drop_index('idx_sale_status')
        batch_op.drop_index('idx_sale_org_date')
        batch_op.drop_index('idx_sale_org')
        batch_op.drop_index('idx_sale_number')
        batch_op.drop_index('idx_sale_date')
        batch_op.drop_index('idx_sale_customer')
        batch_op.drop_index('idx_sale_cashier')
        batch_op.drop_index('idx_sale_branch_date')
        batch_op.drop_index('idx_sale_branch')

    op.drop_table('sales')
    with op.batch_alter_table('prescriptions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_prescriptions_updated_at'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_sync_status'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_status'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_prescription_number'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_organization_id'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_issue_date'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_expiry_date'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_customer_id'))
        batch_op.drop_index(batch_op.f('ix_prescriptions_created_at'))
        batch_op.drop_index('idx_prescription_status')
        batch_op.drop_index('idx_prescription_org')
        batch_op.drop_index('idx_prescription_issue_date')
        batch_op.drop_index('idx_prescription_expiry')
        batch_op.drop_index('idx_prescription_customer')

    op.drop_table('prescriptions')
    with op.batch_alter_table('system_alerts', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_system_alerts_updated_at'))
        batch_op.drop_index(batch_op.f('ix_system_alerts_severity'))
        batch_op.drop_index(batch_op.f('ix_system_alerts_organization_id'))
        batch_op.drop_index(batch_op.f('ix_system_alerts_is_resolved'))
        batch_op.drop_index(batch_op.f('ix_system_alerts_created_at'))
        batch_op.drop_index(batch_op.f('ix_system_alerts_branch_id'))
        batch_op.drop_index(batch_op.f('ix_system_alerts_alert_type'))
        batch_op.drop_index('idx_alert_unresolved', postgresql_where=sa.text('is_resolved = false'))
        batch_op.drop_index('idx_alert_type')
        batch_op.drop_index('idx_alert_severity')
        batch_op.drop_index('idx_alert_resolved')
        batch_op.drop_index('idx_alert_org')
        batch_op.drop_index('idx_alert_branch')

    op.drop_table('system_alerts')
    with op.batch_alter_table('stock_adjustments', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_stock_adjustments_updated_at'))
        batch_op.drop_index(batch_op.f('ix_stock_adjustments_drug_id'))
        batch_op.drop_index(batch_op.f('ix_stock_adjustments_created_at'))
        batch_op.drop_index(batch_op.f('ix_stock_adjustments_branch_id'))
        batch_op.drop_index(batch_op.f('ix_stock_adjustments_adjustment_type'))
        batch_op.drop_index(batch_op.f('ix_stock_adjustments_adjusted_by'))
        batch_op.drop_index('idx_adjustment_type')
        batch_op.drop_index('idx_adjustment_drug')
        batch_op.drop_index('idx_adjustment_date')
        batch_op.drop_index('idx_adjustment_branch')

    op.drop_table('stock_adjustments')
    with op.batch_alter_table('purchase_order_items', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_purchase_order_items_updated_at'))
        batch_op.drop_index(batch_op.f('ix_purchase_order_items_purchase_order_id'))
        batch_op.drop_index(batch_op.f('ix_purchase_order_items_created_at'))
        batch_op.drop_index('idx_po_item_po')
        batch_op.drop_index('idx_po_item_drug')

    op.drop_table('purchase_order_items')
    with op.batch_alter_table('price_contract_items', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_price_contract_items_updated_at'))
        batch_op.drop_index(batch_op.f('ix_price_contract_items_drug_id'))
        batch_op.drop_index(batch_op.f('ix_price_contract_items_created_at'))
        batch_op.drop_index(batch_op.f('ix_price_contract_items_contract_id'))
        batch_op.drop_index('idx_contract_item_drug')
        batch_op.drop_index('idx_contract_item_contract')

    op.drop_table('price_contract_items')
    with op.batch_alter_table('drug_batches', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_drug_batches_updated_at'))
        batch_op.drop_index(batch_op.f('ix_drug_batches_sync_status'))
        batch_op.drop_index(batch_op.f('ix_drug_batches_expiry_date'))
        batch_op.drop_index(batch_op.f('ix_drug_batches_drug_id'))
        batch_op.drop_index(batch_op.f('ix_drug_batches_created_at'))
        batch_op.drop_index(batch_op.f('ix_drug_batches_branch_id'))
        batch_op.drop_index(batch_op.f('ix_drug_batches_batch_number'))
        batch_op.drop_index('idx_batch_remaining')
        batch_op.drop_index('idx_batch_expiry')
        batch_op.drop_index('idx_batch_expiring_stock', postgresql_where=sa.text('remaining_quantity > 0'))
        batch_op.drop_index('idx_batch_drug')
        batch_op.drop_index('idx_batch_branch')

    op.drop_table('drug_batches')
    with op.batch_alter_table('customers', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_customers_updated_at'))
        batch_op.drop_index(batch_op.f('ix_customers_sync_status'))
        batch_op.drop_index(batch_op.f('ix_customers_phone'))
        batch_op.drop_index(batch_op.f('ix_customers_organization_id'))
        batch_op.drop_index(batch_op.f('ix_customers_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_customers_insurance_provider_id'))
        batch_op.drop_index(batch_op.f('ix_customers_insurance_member_id'))
        batch_op.drop_index(batch_op.f('ix_customers_email'))
        batch_op.drop_index(batch_op.f('ix_customers_customer_type'))
        batch_op.drop_index(batch_op.f('ix_customers_created_at'))
        batch_op.drop_index('idx_customer_type')
        batch_op.drop_index('idx_customer_phone')
        batch_op.drop_index('idx_customer_org')
        batch_op.drop_index('idx_customer_loyalty')
        batch_op.drop_index('idx_customer_email')

    op.drop_table('customers')
    with op.batch_alter_table('branch_inventory', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_branch_inventory_updated_at'))
        batch_op.drop_index(batch_op.f('ix_branch_inventory_sync_status'))
        batch_op.drop_index(batch_op.f('ix_branch_inventory_drug_id'))
        batch_op.drop_index(batch_op.f('ix_branch_inventory_created_at'))
        batch_op.drop_index(batch_op.f('ix_branch_inventory_branch_id'))
        batch_op.drop_index('idx_inventory_sync')
        batch_op.drop_index('idx_inventory_quantity')
        batch_op.drop_index('idx_inventory_drug')
        batch_op.drop_index('idx_inventory_branch')

    op.drop_table('branch_inventory')
    with op.batch_alter_table('purchase_orders', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_purchase_orders_updated_at'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_sync_status'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_supplier_id'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_status'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_po_number'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_organization_id'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_expected_delivery_date'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_created_at'))
        batch_op.drop_index(batch_op.f('ix_purchase_orders_branch_id'))
        batch_op.drop_index('idx_po_supplier')
        batch_op.drop_index('idx_po_status')
        batch_op.drop_index('idx_po_org')
        batch_op.drop_index('idx_po_expected_delivery')
        batch_op.drop_index('idx_po_branch')

    op.drop_table('purchase_orders')
    with op.batch_alter_table('price_contracts', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_price_contracts_updated_at'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_sync_status'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_status'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_organization_id'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_is_default_contract'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_is_active'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_insurance_provider_id'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_effective_to'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_effective_from'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_created_at'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_contract_type'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_contract_code'))
        batch_op.drop_index(batch_op.f('ix_price_contracts_applies_to_all_branches'))
        batch_op.drop_index('idx_contract_type')
        batch_op.drop_index('idx_contract_status')
        batch_op.drop_index('idx_contract_org')
        batch_op.drop_index('idx_contract_insurance')
        batch_op.drop_index('idx_contract_default_unique', postgresql_where='is_default_contract = TRUE')
        batch_op.drop_index('idx_contract_dates')
        batch_op.drop_index('idx_contract_code')
        batch_op.drop_index('idx_contract_active_dates', postgresql_where="is_active = TRUE AND status = 'active'")

    op.drop_table('price_contracts')
    with op.batch_alter_table('drugs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_drugs_updated_at'))
        batch_op.drop_index(batch_op.f('ix_drugs_unit_price'))
        batch_op.drop_index(batch_op.f('ix_drugs_sync_status'))
        batch_op.drop_index(batch_op.f('ix_drugs_sku'))
        batch_op.drop_index(batch_op.f('ix_drugs_requires_prescription'))
        batch_op.drop_index(batch_op.f('ix_drugs_organization_id'))
        batch_op.drop_index(batch_op.f('ix_drugs_name'))
        batch_op.drop_index(batch_op.f('ix_drugs_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_drugs_is_active'))
        batch_op.drop_index(batch_op.f('ix_drugs_generic_name'))
        batch_op.drop_index(batch_op.f('ix_drugs_drug_type'))
        batch_op.drop_index(batch_op.f('ix_drugs_created_at'))
        batch_op.drop_index(batch_op.f('ix_drugs_category_id'))
        batch_op.drop_index(batch_op.f('ix_drugs_barcode'))
        batch_op.drop_index('idx_drug_type')
        batch_op.drop_index('idx_drug_sync')
        batch_op.drop_index('idx_drug_sku')
        batch_op.drop_index('idx_drug_search', postgresql_using='gin')
        batch_op.drop_index('idx_drug_org_type')
        batch_op.drop_index('idx_drug_org_active')
        batch_op.drop_index('idx_drug_org')
        batch_op.drop_index('idx_drug_name')
        batch_op.drop_index('idx_drug_generic')
        batch_op.drop_index('idx_drug_category')
        batch_op.drop_index('idx_drug_barcode')
        batch_op.drop_index('idx_drug_active')

    op.drop_table('drugs')
    with op.batch_alter_table('user_sessions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_sessions_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_sessions_updated_at'))
        batch_op.drop_index(batch_op.f('ix_user_sessions_token_hash'))
        batch_op.drop_index(batch_op.f('ix_user_sessions_refresh_token_hash'))
        batch_op.drop_index(batch_op.f('ix_user_sessions_is_revoked'))
        batch_op.drop_index(batch_op.f('ix_user_sessions_expires_at'))
        batch_op.drop_index(batch_op.f('ix_user_sessions_created_at'))
        batch_op.drop_index('idx_session_user')
        batch_op.drop_index('idx_session_token')
        batch_op.drop_index('idx_session_expires')
        batch_op.drop_index('idx_session_active')

    op.drop_table('user_sessions')
    with op.batch_alter_table('suppliers', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_suppliers_updated_at'))
        batch_op.drop_index(batch_op.f('ix_suppliers_sync_status'))
        batch_op.drop_index(batch_op.f('ix_suppliers_organization_id'))
        batch_op.drop_index(batch_op.f('ix_suppliers_name'))
        batch_op.drop_index(batch_op.f('ix_suppliers_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_suppliers_is_active'))
        batch_op.drop_index(batch_op.f('ix_suppliers_created_at'))
        batch_op.drop_index('idx_supplier_org')
        batch_op.drop_index('idx_supplier_active')

    op.drop_table('suppliers')
    with op.batch_alter_table('insurance_providers', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_insurance_providers_updated_at'))
        batch_op.drop_index(batch_op.f('ix_insurance_providers_sync_status'))
        batch_op.drop_index(batch_op.f('ix_insurance_providers_organization_id'))
        batch_op.drop_index(batch_op.f('ix_insurance_providers_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_insurance_providers_is_active'))
        batch_op.drop_index(batch_op.f('ix_insurance_providers_created_at'))
        batch_op.drop_index(batch_op.f('ix_insurance_providers_code'))
        batch_op.drop_index('idx_insurance_org')
        batch_op.drop_index('idx_insurance_code')
        batch_op.drop_index('idx_insurance_active')

    op.drop_table('insurance_providers')
    with op.batch_alter_table('drug_categories', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_drug_categories_updated_at'))
        batch_op.drop_index(batch_op.f('ix_drug_categories_sync_status'))
        batch_op.drop_index(batch_op.f('ix_drug_categories_parent_id'))
        batch_op.drop_index(batch_op.f('ix_drug_categories_organization_id'))
        batch_op.drop_index(batch_op.f('ix_drug_categories_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_drug_categories_created_at'))
        batch_op.drop_index('idx_category_path')
        batch_op.drop_index('idx_category_parent')
        batch_op.drop_index('idx_category_org')

    op.drop_table('drug_categories')
    with op.batch_alter_table('branches', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_branches_updated_at'))
        batch_op.drop_index(batch_op.f('ix_branches_sync_status'))
        batch_op.drop_index(batch_op.f('ix_branches_organization_id'))
        batch_op.drop_index(batch_op.f('ix_branches_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_branches_is_active'))
        batch_op.drop_index(batch_op.f('ix_branches_created_at'))
        batch_op.drop_index(batch_op.f('ix_branches_code'))
        batch_op.drop_index('idx_branch_org')
        batch_op.drop_index('idx_branch_code')
        batch_op.drop_index('idx_branch_active')

    op.drop_table('branches')
    with op.batch_alter_table('audit_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_audit_logs_user_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_organization_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_entity_type'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_entity_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_created_at'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_action'))
        batch_op.drop_index('idx_audit_user')
        batch_op.drop_index('idx_audit_org')
        batch_op.drop_index('idx_audit_entity')
        batch_op.drop_index('idx_audit_date')
        batch_op.drop_index('idx_audit_action')

    op.drop_table('audit_logs')
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_users_username'))
        batch_op.drop_index(batch_op.f('ix_users_updated_at'))
        batch_op.drop_index(batch_op.f('ix_users_sync_status'))
        batch_op.drop_index(batch_op.f('ix_users_role'))
        batch_op.drop_index(batch_op.f('ix_users_organization_id'))
        batch_op.drop_index(batch_op.f('ix_users_is_deleted'))
        batch_op.drop_index(batch_op.f('ix_users_is_active'))
        batch_op.drop_index(batch_op.f('ix_users_email'))
        batch_op.drop_index(batch_op.f('ix_users_created_at'))
        batch_op.drop_index('idx_user_role')
        batch_op.drop_index('idx_user_org')
        batch_op.drop_index('idx_user_active')

    op.drop_table('users')
    with op.batch_alter_table('sync_queue', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_sync_queue_table_name'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_status'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_scheduled_at'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_record_id'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_organization_id'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_created_at'))
        batch_op.drop_index('idx_sync_queue_status')
        batch_op.drop_index('idx_sync_queue_scheduled')
        batch_op.drop_index('idx_sync_queue_pending', postgresql_where=sa.text("status = 'pending'"))
        batch_op.drop_index('idx_sync_queue_org')

    op.drop_table('sync_queue')
    with op.batch_alter_table('organizations', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_organizations_updated_at'))
        batch_op.drop_index(batch_op.f('ix_organizations_sync_status'))
        batch_op.drop_index(batch_op.f('ix_organizations_name'))
        batch_op.drop_index(batch_op.f('ix_organizations_is_active'))
        batch_op.drop_index(batch_op.f('ix_organizations_created_at'))
        batch_op.drop_index('idx_org_subscription')
        batch_op.drop_index('idx_org_active')

    op.drop_table('organizations')
    # ### end Alembic commands ###
